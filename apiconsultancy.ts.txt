// File: api/consultancy.ts
import { GoogleGenAI, GenerateContentResponse } from "@google/genai";

// Esta função também é executada no servidor da Vercel.
export async function POST(req: Request) {
  try {
    const { base64Image } = await req.json();
    
    const apiKey = process.env.API_KEY;
    if (!apiKey) {
      return new Response("API key not configured", { status: 500 });
    }
    
    const ai = new GoogleGenAI({ apiKey });

    const SYSTEM_INSTRUCTION_CONSULTANCY = `
      You are an expert Lash Designer consultant for Havilah Lash Studio...
      // (Copie o system instruction completo do geminiService.ts aqui)
    `;

    const model = 'gemini-3-flash-preview';

    const response: GenerateContentResponse = await ai.models.generateContent({
      model,
      contents: {
        parts: [
          { inlineData: { mimeType: 'image/jpeg', data: base64Image } },
          { text: "Analise este rosto e recomende o melhor estilo de cílios do catálogo Havilah." }
        ]
      },
      config: { systemInstruction: SYSTEM_INSTRUCTION_CONSULTANCY }
    });

    return new Response(JSON.stringify({ result: response.text }), {
      headers: { 'Content-Type': 'application/json' },
    });

  } catch (error) {
    console.error("API Consultancy Error:", error);
    return new Response("Error processing image analysis.", { status: 500 });
  }
}